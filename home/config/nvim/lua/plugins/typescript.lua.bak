return {
	{
		"neovim/nvim-lspconfig",
		opts = {
			servers = {
				vtsls = {
					settings = {
						typescript = {
							preferences = {
								-- Prefer non-relative imports
								importModuleSpecifier = "non-relative",
								includePackageJsonAutoImports = "off",
							},
							-- Inlay hints
							inlayHints = {
								enumMemberValues = { enabled = true },
								functionLikeReturnTypes = { enabled = true },
								parameterNames = { enabled = "literals" },
								parameterTypes = { enabled = true },
								propertyDeclarationTypes = { enabled = true },
								variableTypes = { enabled = false },
							},
						},
						javascript = {
							preferences = {
								-- Prefer non-relative imports
								importModuleSpecifier = "non-relative",
								includePackageJsonAutoImports = "off",
							},
						},
						vtsls = {
							experimental = {
								completion = {
									enableServerSideFuzzyMatch = true,
								},
							},
						},
					},
					-- Configure format settings dynamically per buffer on LSP attach
					on_attach = function(client, bufnr)
						-- Read prettier config from package.json
						local function get_prettier_config()
							local cwd = vim.fn.getcwd()
							local package_json_path = cwd .. "/package.json"

							local file = io.open(package_json_path, "r")
							if not file then
								return nil
							end

							local content = file:read("*all")
							file:close()

							local prettier_config = {}

							-- Extract useTabs
							local use_tabs = content:match('"useTabs"%s*:%s*([^,}]+)')
							if use_tabs then
								prettier_config.useTabs = use_tabs:match("true") and true or false
							end

							-- Extract tabWidth
							local tab_width = content:match('"tabWidth"%s*:%s*(%d+)')
							if tab_width then
								prettier_config.tabWidth = tonumber(tab_width)
							end

							return prettier_config
						end

						-- Get prettier config or fall back to buffer settings
						local prettier_config = get_prettier_config()
						local indent_size, convert_tabs, tab_size

						if prettier_config and prettier_config.tabWidth then
							-- Use prettier config
							indent_size = prettier_config.tabWidth
							convert_tabs = not prettier_config.useTabs
							tab_size = prettier_config.tabWidth
						else
							-- Fall back to buffer-local settings
							indent_size = vim.bo[bufnr].shiftwidth
							convert_tabs = vim.bo[bufnr].expandtab
							tab_size = vim.bo[bufnr].tabstop
						end

						-- Update LSP workspace configuration
						client.config.settings.typescript = client.config.settings.typescript or {}
						client.config.settings.typescript.format = {
							indentSize = indent_size,
							convertTabsToSpaces = convert_tabs,
							tabSize = tab_size,
						}

						client.config.settings.javascript = client.config.settings.javascript or {}
						client.config.settings.javascript.format = {
							indentSize = indent_size,
							convertTabsToSpaces = convert_tabs,
							tabSize = tab_size,
						}

						-- Notify the server of the updated settings
						client.notify("workspace/didChangeConfiguration", { settings = client.config.settings })
					end,
				},
			},
		},
	},
	{
		"nvim-lspconfig",
		opts = function(_, opts)
			-- Helper to get prettier config
			local function get_prettier_config()
				local cwd = vim.fn.getcwd()
				local package_json_path = cwd .. "/package.json"

				local file = io.open(package_json_path, "r")
				if not file then
					return nil
				end

				local content = file:read("*all")
				file:close()

				local prettier_config = {}

				-- Extract useTabs
				local use_tabs = content:match('"useTabs"%s*:%s*([^,}]+)')
				if use_tabs then
					prettier_config.useTabs = use_tabs:match("true") and true or false
				end

				-- Extract tabWidth
				local tab_width = content:match('"tabWidth"%s*:%s*(%d+)')
				if tab_width then
					prettier_config.tabWidth = tonumber(tab_width)
				end

				return prettier_config
			end

			-- Auto-organize imports on save (synchronously)
			local function organize_imports()
				-- Get the vtsls client
				local clients = vim.lsp.get_clients({ bufnr = 0, name = "vtsls" })
				if #clients == 0 then
					return
				end
				local client = clients[1]

				-- Get prettier config
				local prettier_config = get_prettier_config()
				local indent_size, convert_tabs, tab_size

				if prettier_config and prettier_config.tabWidth then
					indent_size = prettier_config.tabWidth
					convert_tabs = not prettier_config.useTabs
					tab_size = prettier_config.tabWidth
				else
					indent_size = vim.bo.shiftwidth
					convert_tabs = vim.bo.expandtab
					tab_size = vim.bo.tabstop
				end

				-- Update format settings right before organizing imports
				client.config.settings.typescript = client.config.settings.typescript or {}
				client.config.settings.typescript.format = {
					indentSize = indent_size,
					convertTabsToSpaces = convert_tabs,
					tabSize = tab_size,
				}

				client.config.settings.javascript = client.config.settings.javascript or {}
				client.config.settings.javascript.format = {
					indentSize = indent_size,
					convertTabsToSpaces = convert_tabs,
					tabSize = tab_size,
				}

				-- Send configuration update and wait a bit for it to be processed
				client.notify("workspace/didChangeConfiguration", { settings = client.config.settings })

				-- Small delay to ensure config is processed
				vim.wait(50)

				-- Now organize imports
				local params = {
					command = "typescript.organizeImports",
					arguments = { vim.api.nvim_buf_get_name(0) },
				}

				local result = vim.lsp.buf_request_sync(0, "workspace/executeCommand", params, 1000)
				if not result or vim.tbl_isempty(result) then
					return
				end
			end

			-- Set up autocmd for organize imports on save (TypeScript/JavaScript)
			vim.api.nvim_create_autocmd("BufWritePre", {
				pattern = { "*.ts", "*.tsx", "*.js", "*.jsx" },
				callback = function()
					organize_imports()
				end,
			})

			-- Set up autocmd for organize imports on save (Astro files)
			vim.api.nvim_create_autocmd("BufWritePre", {
				pattern = { "*.astro" },
				callback = function()
					-- Use synchronous code action request to prevent race condition
					local params = vim.lsp.util.make_range_params()
					params.context = {
						only = { "source.organizeImports" },
						diagnostics = {},
					}

					local result = vim.lsp.buf_request_sync(0, "textDocument/codeAction", params, 1000)
					if not result or vim.tbl_isempty(result) then
						return
					end

					-- Apply the first available organize imports code action
					for _, res in pairs(result) do
						if res.result then
							for _, action in pairs(res.result) do
								if action.edit or action.command then
									if action.edit then
										vim.lsp.util.apply_workspace_edit(action.edit, "utf-8")
									end
									if action.command then
										vim.lsp.buf.execute_command(action.command)
									end
								end
							end
						end
					end
				end,
			})
		end,
	},
}
